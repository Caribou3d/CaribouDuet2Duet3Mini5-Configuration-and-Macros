; =========================================================================================================
;
; test routine for Duet2 and Duet3Mini5+ WiFi/Ethernet
; part of self check
;
; calibrate extruder esteps for PLA at 215°C
;
; =========================================================================================================
;
if {state.status == "processing"} || {state.status == "paused"}        ; printer is not currently printing!
    M291 S2 P"Cannot run during an ongoing print. Please run this macro when the printer is paused!" R"WARNING!"
    M99
;
; =========================================================================================================
;
M291 P"Press OK to continue or CANCEL to abort." R"Run extruder calibration for PLA at 215°C?" S3
;
if !move.axes[0].homed || !move.axes[1].homed || !move.axes[2].homed
  G28                                                                  ; home all axes without mesh bed level
G90                                                                    ; absolute positioning
G0 X60 Y-3 Z80                                                         ; move extruder above bed, keep extruder in front for cleaning and checking
;
T0                                                                     ; select tool 0
M568 P0 S215 A2                                                        ; pre-heat extruder to 215°C
;
M291 S2 R"Heating to 215°C" P"Mark 120mm on filament from top of extruder body."
;
M116                                                                   ; wait for temp to 215°C
;
M291 S2 R"Temperature reached. Extruding 100mm filament at 1mm/s" P"Press OK to start."
;
M83                                                                    ; relative extrusion
G1 E100 F60                                                            ; extrude 100mm of filament at 1mm/s
M400                                                                   ; wait for moves to finish
M568 P0 S0 R0 A0                                                       ; turn off extruder
;
M291 S2 R"Measure distance to mark and update e steps in config.g." P{"new_e_steps = " ^ move.extruders[0].stepsPerMm ^ " * (100 / (120 - distance_to_mark_in_mm))"}
M291 S2 P"Repeat test to verify." R"Extruder calibration done."
;
; =========================================================================================================
;